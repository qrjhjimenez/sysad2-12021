---
# tasks file for roles/logstash
- name: Installing Java
  apt:
   name: openjdk-11-jdk
   update_cache: yes

- name: Importing the Logstash public GPG key into APT
  apt_key:
   url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
   state: present

- name: Adding Logstash source list
  lineinfile:
   path: /etc/apt/sources.list.d/elastic-7.x.list
   line: '{{ logstash_source }}'
   create: yes

- name: Installing Logstash
  apt:
   name: logstash
   update_cache: yes

- name: Installing Filebeat
  apt:
   name: filebeat
   update_cache: yes

- name: Creating 1st configuration file
  copy:
   src: 02-beats-input.conf
   dest: /etc/logstash/conf.d

- name: Creating 2nd configuration file
  copy:
   src: 10-syslog-filter.conf
   dest: /etc/logstash/conf.d
 
- name: Creating 3rd configuration file
  copy:
   src: 30-elasticsearch-output.conf
   dest:  /etc/logstash/conf.d

- name: Starting Logstash
  service:
   name: logstash
   state: started
   enabled:

- name: Editing Filebeat Configuration output.elasticsearch
  replace:
   path: /etc/filebeat/filebeat.yml
   regexp: 'output.elasticsearch:'
   replace: '#output.elasticsearch:'

- name: Editing Filebeat Configuration hosts
  replace:
   path: /etc/filebeat/filebeat.yml
   regexp: 'hosts:'
   replace: '#hosts:'
   after: 'output.elasticsearch:'
   before: 'Protocol - either'

- name: Editing Filebeat Configuration output.logstash
  replace:
   path: /etc/filebeat/filebeat.yml
   regexp: '#output.logstash:'
   replace: 'output.logstash:'

- name: Editing Filebeat Configuration hosts
  replace:
   path: /etc/filebeat/filebeat.yml
   regexp: '#hosts:'
   replace: 'hosts:'
   after: 'output.logstash:'
   before: ' Optional SSL.'

- name: Enabling filebeat modules
  shell: 'filebeat modules enable system'

- name: Starting filebeat
  service:
   name: filebeat
   state: started
   enabled: yes


